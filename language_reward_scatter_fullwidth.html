<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Niche Language Exploit | Fenwick Tutoring</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: white;
            color: #000;
            line-height: 1.6;
        }
        #chart, #chart * {
            touch-action: pan-y !important; 
        }
        .container {
            width: 100%;
            max-width: none;
            margin: 0;
            background-color: white;
            padding: 30px 5%;
        }
        
        h1 {
            color: #5d2137;
            font-size: clamp(22px, 4vw, 32px);
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .subtitle {
            color: #ba684e;
            font-size: clamp(14px, 2vw, 18px);
            margin-bottom: 25px;
        }
        
        .insight-box {
            background-color: #fee9e2;
            border-left: 4px solid #ba684e;
            border-radius: 8px;
            padding: 20px;
            margin: 25px 0;
        }
        
        .insight-box h3 {
            color: #5d2137;
            font-size: 18px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }
        
        .insight-box p {
            color: #000;
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .insight-box p:last-child {
            margin-bottom: 0;
        }
        
        .insight-box strong {
            color: #5d2137;
        }
        
        #chart {
            width: 100%;
            height: 600px;
            margin: 30px 0 15px 0;
        }
        
        /* Search Container */
        .search-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto 30px auto;
        }
        
        .search-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            background: #fee9e2;
            border: 2px solid #ba684e;
            border-radius: 8px;
            overflow: hidden;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        .search-wrapper:focus-within {
            border-color: #5d2137;
            box-shadow: 0 0 0 3px rgba(93, 33, 55, 0.15);
        }
        
        .search-icon {
            padding: 0 12px;
            color: #ba684e;
            display: flex;
            align-items: center;
        }
        
        .search-icon svg {
            width: 18px;
            height: 18px;
        }
        
        #subject-search {
            flex: 1;
            padding: 12px 12px 12px 0;
            border: none;
            background: transparent;
            font-size: 15px;
            color: #5d2137;
            outline: none;
            font-family: inherit;
        }
        
        #subject-search::placeholder {
            color: #ba684e;
            opacity: 0.7;
        }
        
        .clear-btn {
            padding: 8px 12px;
            background: none;
            border: none;
            color: #ba684e;
            cursor: pointer;
            font-size: 18px;
            display: none;
            transition: color 0.2s ease;
        }
        
        .clear-btn:hover {
            color: #5d2137;
        }
        
        .clear-btn.visible {
            display: block;
        }
        
        /* Dropdown */
        .dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #ba684e;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(93, 33, 55, 0.15);
        }
        
        .dropdown.active {
            display: block;
        }
        
        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #fee9e2;
            transition: background-color 0.15s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item:hover,
        .dropdown-item.highlighted {
            background-color: #fee9e2;
        }
        
        .dropdown-item .subject-name {
            flex: 1;
            color: #5d2137;
            font-weight: 500;
        }
        
        .dropdown-item .size-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            color: white;
            font-weight: 600;
        }
        
        .no-results {
            padding: 16px;
            text-align: center;
            color: #ba684e;
            font-style: italic;
        }
        
        /* Selected subject info card */
        .selected-info {
            display: none;
            background: linear-gradient(135deg, #fee9e2 0%, #fff 100%);
            border: 2px solid #ba684e;
            border-radius: 8px;
            padding: 16px 20px;
            margin: 15px auto 25px auto;
            max-width: 400px;
            animation: slideIn 0.3s ease;
        }
        
        .selected-info.active {
            display: block;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .selected-info .info-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .selected-info .size-badge {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 4px;
            color: white;
            font-weight: 600;
        }
        
        .selected-info .subject-title {
            color: #5d2137;
            font-weight: 700;
            font-size: 17px;
        }
        
        .selected-info .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px 16px;
        }
        
        .selected-info .info-item {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .selected-info .info-label {
            color: #ba684e;
            font-weight: 500;
        }
        
        .selected-info .info-value {
            color: #5d2137;
            font-weight: 600;
        }
        
        .footer {
            text-align: center;
            color: #ba684e;
            font-size: 13px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #fee9e2;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin: 25px 0;
        }
        
        .stat-card {
            background-color: #fee9e2;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }
        
        .stat-card .value {
            color: #5d2137;
            font-size: 28px;
            font-weight: bold;
        }
        
        .stat-card .label {
            color: #ba684e;
            font-size: 13px;
            margin-top: 5px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px 4%;
            }

            #chart {
                height: 280px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .stat-card .value {
                font-size: 22px;
            }

            #subject-search {
                font-size: 16px;
                padding: 14px 12px 14px 0;
            }

            .search-container {
                max-width: 100%;
            }

            .dropdown {
                max-height: 200px;
            }

            .dropdown-item {
                padding: 14px 16px;
            }

            .selected-info {
                max-width: 100%;
                padding: 14px 16px;
            }

            .selected-info .info-grid {
                grid-template-columns: 1fr;
                gap: 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>The Niche Language Exploit</h1>
        <p class="subtitle">Analysing grade outcomes across 139 IB language subjects — Literature vs Language and Literature</p>
        
        <div id="chart"></div>
        
        <!-- Search Bar -->
        <div class="search-container">
            <div class="search-wrapper">
                <div class="search-icon">
                    <svg fill="currentColor" viewBox="0 0 16 16">
                        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                    </svg>
                </div>
                <input 
                    type="text" 
                    id="subject-search" 
                    placeholder="Search for a language..."
                    autocomplete="off"
                >
                <button class="clear-btn" id="clear-search">×</button>
            </div>
            <div class="dropdown" id="dropdown"></div>
        </div>
        
        <!-- Selected Subject Info -->
        <div class="selected-info" id="selected-info">
            <div class="info-header">
                <span class="size-badge" id="info-badge"></span>
                <span class="subject-title" id="info-title"></span>
            </div>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Reward Score:</span>
                    <span class="info-value" id="info-reward"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Students:</span>
                    <span class="info-value" id="info-students"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Mean Grade:</span>
                    <span class="info-value" id="info-mean"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Grade 7%:</span>
                    <span class="info-value" id="info-grade7"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Grade 6-7%:</span>
                    <span class="info-value" id="info-grade67"></span>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p><strong>Fenwick Tutoring</strong> | Data: IB May 2025 Statistical Bulletin</p>
            <p>Reward Score = (40% × Grade 7%) + (40% × Grade 6-7%) + (20% × Mean Grade)</p>
        </div>

    </div>
    
    <script>
        // Detect mobile vs desktop using container width (works in iframes too)
        const isMobile = document.querySelector('.container').offsetWidth < 600;
        
        // Global variables for search and chart data
        let allSubjects = [];
        let currentTrace = null;
        let highlightedIndex = -1;
        let litData = { x: [], y: [], text: [], subjects: [] };
        let lalData = { x: [], y: [], text: [], subjects: [] };
        
        // Course type colors
        const typeColors = {
            'Literature': '#5d2137',
            'Language and Literature': '#ba684e'
        };

        // Classify subject by course type
        function getCourseType(subjectName) {
            const upper = subjectName.toUpperCase();
            if (upper.includes('LANGUAGE AND LITERATURE') || upper.includes(' LAL ')) {
                return 'Language and Literature';
            }
            return 'Literature';
        }
        
        // Load and process the CSV data
        fetch('./language_lit_reward_analysis.csv')
            .then(response => response.text())
            .then(data => {
                // Parse CSV
                const rows = data.split('\n').slice(1);
                const subjects = [];
                const students = [];
                const rewardScores = [];
                const meanGrades = [];
                const grade7Pct = [];
                const grade67Pct = [];
                
                rows.forEach(row => {
                    if (row.trim()) {
                        const cols = row.split(',');
                        subjects.push(cols[0]);
                        students.push(parseFloat(cols[1]));
                        meanGrades.push(parseFloat(cols[2]));
                        grade7Pct.push(parseFloat(cols[3]));
                        grade67Pct.push(parseFloat(cols[5]));
                        rewardScores.push(parseFloat(cols[6]));
                    }
                });
                
                // Store all subjects for search
                allSubjects = subjects.map((subj, i) => {
                    return {
                        subject: subj,
                        students: students[i],
                        rewardScore: rewardScores[i],
                        meanGrade: meanGrades[i],
                        grade7: grade7Pct[i],
                        grade67: grade67Pct[i],
                        courseType: getCourseType(subj)
                    };
                });

                // Split data into two traces by course type
                litData = { x: [], y: [], text: [], subjects: [] };
                lalData = { x: [], y: [], text: [], subjects: [] };

                allSubjects.forEach((subj, i) => {
                    const bucket = subj.courseType === 'Literature' ? litData : lalData;
                    bucket.x.push(subj.students);
                    bucket.y.push(subj.rewardScore);
                    bucket.subjects.push(subj);

                    const hoverStr = isMobile
                        ? `<b>${subj.subject}</b><br>` +
                          `Reward Score: ${subj.rewardScore.toFixed(2)}<br>` +
                          `Students: ${subj.students.toLocaleString()}`
                        : `<b>${subj.subject}</b><br>` +
                          `Students: ${subj.students.toLocaleString()}<br>` +
                          `Reward Score: ${subj.rewardScore.toFixed(2)}<br>` +
                          `Mean Grade: ${subj.meanGrade.toFixed(2)}<br>` +
                          `Grade 7%: ${subj.grade7.toFixed(1)}%<br>` +
                          `Grade 6-7%: ${subj.grade67.toFixed(1)}%<br>` +
                          `Type: ${subj.courseType}`;
                    bucket.text.push(hoverStr);
                });
                
                const traceLit = {
                    x: litData.x,
                    y: litData.y,
                    mode: 'markers',
                    type: 'scatter',
                    name: 'Literature',
                    text: litData.text,
                    hoverinfo: 'text',
                    marker: {
                        size: isMobile ? 8 : 10,
                        color: typeColors['Literature'],
                        opacity: 0.7,
                        line: { color: '#5d2137', width: 1 }
                    },
                    hoverlabel: { font: { size: isMobile ? 11 : 13 } },
                    showlegend: true
                };

                const traceLal = {
                    x: lalData.x,
                    y: lalData.y,
                    mode: 'markers',
                    type: 'scatter',
                    name: 'Language & Literature',
                    text: lalData.text,
                    hoverinfo: 'text',
                    marker: {
                        size: isMobile ? 8 : 10,
                        color: typeColors['Language and Literature'],
                        opacity: 0.7,
                        line: { color: '#5d2137', width: 1 }
                    },
                    hoverlabel: { font: { size: isMobile ? 11 : 13 } },
                    showlegend: true
                };

                currentTrace = [traceLit, traceLal];
                
                const layout = {
                    xaxis: {
                        title: {
                            text: 'Number of Students (log scale)',
                            font: {
                                size: isMobile ? 11 : 14,
                                color: '#5d2137',
                                family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto'
                            }
                        },
                        type: 'log',
                        gridcolor: '#fee9e2',
                        zeroline: false,
                        fixedrange: true
                    },
                    yaxis: {
                        title: {
                            text: 'Reward Score',
                            font: {
                                size: isMobile ? 11 : 14,
                                color: '#5d2137',
                                family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto'
                            }
                        },
                        gridcolor: '#fee9e2',
                        zeroline: false,
                        range: [5, 78],
                        fixedrange: true
                    },
                    showlegend: !isMobile,
                    legend: {
                        x: 0.98,
                        y: 0.98,
                        xanchor: 'right',
                        yanchor: 'top',
                        bgcolor: 'rgba(255,255,255,0.9)',
                        bordercolor: '#ba684e',
                        borderwidth: 1,
                        font: { size: 12, color: '#5d2137' }
                    },
                    hovermode: 'closest',
                    dragmode: false,
                    plot_bgcolor: 'white',
                    paper_bgcolor: 'white',
                    font: {
                        family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto',
                        color: '#000'
                    },
                    margin: isMobile 
                        ? { l: 35, r: 10, t: 20, b: 50 }
                        : { l: 60, r: 30, t: 30, b: 60 },
                    annotations: isMobile ? [] : [
                        {
                            x: Math.log10(50),
                            y: 45,
                            xref: 'x',
                            yref: 'y',
                            text: 'Small cohorts:<br>Higher rewards',
                            showarrow: true,
                            arrowhead: 2,
                            arrowsize: 1,
                            arrowwidth: 2,
                            arrowcolor: '#ba684e',
                            ax: -60,
                            ay: -60,
                            font: {
                                size: 12,
                                color: '#5d2137'
                            },
                            bgcolor: '#fee9e2',
                            bordercolor: '#ba684e',
                            borderwidth: 2,
                            borderpad: 4,
                            opacity: 0.9
                        },
                        {
                            x: Math.log10(30000),
                            y: 12,
                            xref: 'x',
                            yref: 'y',
                            text: 'Large cohorts:<br>Lower rewards',
                            showarrow: true,
                            arrowhead: 2,
                            arrowsize: 1,
                            arrowwidth: 2,
                            arrowcolor: '#ba684e',
                            ax: 60,
                            ay: 60,
                            font: {
                                size: 12,
                                color: '#5d2137'
                            },
                            bgcolor: '#fee9e2',
                            bordercolor: '#ba684e',
                            borderwidth: 2,
                            borderpad: 4,
                            opacity: 0.9
                        }
                    ]
                };
                
                const config = {
                    responsive: true,
                    displayModeBar: !isMobile,
                    displaylogo: false,
                    modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                    toImageButtonOptions: {
                        format: 'png',
                        filename: 'language_reward_scatter_fenwick_tutoring',
                        height: 800,
                        width: 1400,
                        scale: 2
                    },
                    scrollZoom: false
                };
                
                Plotly.newPlot('chart', [traceLit, traceLal], layout, config);

                // Initialize search functionality
                initializeSearch();

                // Responsive resize: adjust layout based on container width
                function handleResize() {
                    const chartEl = document.getElementById('chart');
                    const narrow = chartEl.offsetWidth < 500;
                    const w = chartEl.offsetWidth;
                    chartEl.style.height = narrow ? '280px' : '550px';
                    Plotly.relayout('chart', {
                        width: w,
                        height: narrow ? 280 : 550,
                        showlegend: !narrow,
                        'margin.l': narrow ? 35 : 60,
                        'margin.r': narrow ? 10 : 30,
                        'margin.t': narrow ? 20 : 30,
                        'margin.b': narrow ? 50 : 60,
                        annotations: narrow ? [] : [
                            {
                                x: Math.log10(50), y: 45,
                                xref: 'x', yref: 'y',
                                text: 'Small cohorts:<br>Higher rewards',
                                showarrow: true, arrowhead: 2, arrowsize: 1,
                                arrowwidth: 2, arrowcolor: '#ba684e',
                                ax: -60, ay: -60,
                                font: { size: 12, color: '#5d2137' },
                                bgcolor: '#fee9e2', bordercolor: '#ba684e',
                                borderwidth: 2, borderpad: 4, opacity: 0.9
                            },
                            {
                                x: Math.log10(30000), y: 12,
                                xref: 'x', yref: 'y',
                                text: 'Large cohorts:<br>Lower rewards',
                                showarrow: true, arrowhead: 2, arrowsize: 1,
                                arrowwidth: 2, arrowcolor: '#ba684e',
                                ax: 60, ay: 60,
                                font: { size: 12, color: '#5d2137' },
                                bgcolor: '#fee9e2', bordercolor: '#ba684e',
                                borderwidth: 2, borderpad: 4, opacity: 0.9
                            }
                        ]
                    });
                }
                window.addEventListener('resize', handleResize);
                handleResize();
            })
            .catch(error => {
                console.error('Error loading data:', error);
                document.getElementById('chart').innerHTML = 
                    '<div style="text-align: center; padding: 50px; color: #ba684e;">' +
                    '<p>Error loading data. Please ensure language_lit_reward_analysis.csv is in the same directory.</p>' +
                    '</div>';
            });
        
        function initializeSearch() {
            const searchInput = document.getElementById('subject-search');
            const dropdown = document.getElementById('dropdown');
            const clearBtn = document.getElementById('clear-search');
            
            // Input handler
            searchInput.addEventListener('input', function() {
                const query = this.value.trim().toLowerCase();
                highlightedIndex = -1;
                
                if (query.length === 0) {
                    dropdown.classList.remove('active');
                    clearBtn.classList.remove('visible');
                    return;
                }
                
                clearBtn.classList.add('visible');
                
                const matches = allSubjects.filter(s => 
                    s.subject.toLowerCase().includes(query)
                );
                
                renderDropdown(matches);
            });
            
            // Keyboard navigation
            searchInput.addEventListener('keydown', function(e) {
                const items = dropdown.querySelectorAll('.dropdown-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    highlightedIndex = Math.min(highlightedIndex + 1, items.length - 1);
                    updateHighlight(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    highlightedIndex = Math.max(highlightedIndex - 1, 0);
                    updateHighlight(items);
                } else if (e.key === 'Enter' && highlightedIndex >= 0 && items[highlightedIndex]) {
                    e.preventDefault();
                    selectSubject(items[highlightedIndex].dataset.name);
                }
            });
            
            // Clear button
            clearBtn.addEventListener('click', function() {
                searchInput.value = '';
                clearBtn.classList.remove('visible');
                dropdown.classList.remove('active');
                resetChartHighlight();
                document.getElementById('selected-info').classList.remove('active');
                searchInput.focus();
            });
            
            // Click outside to close
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container')) {
                    dropdown.classList.remove('active');
                }
            });
        }
        
        function renderDropdown(matches) {
            const dropdown = document.getElementById('dropdown');
            
            if (matches.length === 0) {
                dropdown.innerHTML = '<div class="no-results">No languages found</div>';
                dropdown.classList.add('active');
                return;
            }
            
            dropdown.innerHTML = matches.map((s, index) => {
                const badgeColor = typeColors[s.courseType];

                return `
                    <div class="dropdown-item" data-name="${s.subject}" data-index="${index}">
                        <span class="size-badge" style="background-color: ${badgeColor}">${s.courseType}</span>
                        <span class="subject-name">${s.subject}</span>
                    </div>
                `;
            }).join('');
            
            // Add click handlers
            dropdown.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', function() {
                    selectSubject(this.dataset.name);
                });
            });
            
            dropdown.classList.add('active');
        }
        
        function updateHighlight(items) {
            items.forEach((item, index) => {
                item.classList.toggle('highlighted', index === highlightedIndex);
            });
            
            // Scroll into view if needed
            if (highlightedIndex >= 0 && items[highlightedIndex]) {
                items[highlightedIndex].scrollIntoView({ block: 'nearest' });
            }
        }
        
        function selectSubject(subjectName) {
            const searchInput = document.getElementById('subject-search');
            const dropdown = document.getElementById('dropdown');
            const clearBtn = document.getElementById('clear-search');
            
            // Update input
            searchInput.value = subjectName;
            clearBtn.classList.add('visible');
            dropdown.classList.remove('active');
            
            // Find subject data
            const subject = allSubjects.find(s => s.subject === subjectName);
            if (subject) {
                highlightSubjectOnChart(subject);
                showSelectedInfo(subject);
            }
        }
        
        function highlightSubjectOnChart(subject) {
            // Create annotation for the selected point
            const annotations = isMobile ? [] : [
                {
                    x: Math.log10(50),
                    y: 45,
                    xref: 'x',
                    yref: 'y',
                    text: 'Small cohorts:<br>Higher rewards',
                    showarrow: true,
                    arrowhead: 2,
                    arrowsize: 1,
                    arrowwidth: 2,
                    arrowcolor: '#ba684e',
                    ax: -60,
                    ay: -60,
                    font: { size: 12, color: '#5d2137' },
                    bgcolor: '#fee9e2',
                    bordercolor: '#ba684e',
                    borderwidth: 2,
                    borderpad: 4,
                    opacity: 0.9
                },
                {
                    x: Math.log10(30000),
                    y: 12,
                    xref: 'x',
                    yref: 'y',
                    text: 'Large cohorts:<br>Lower rewards',
                    showarrow: true,
                    arrowhead: 2,
                    arrowsize: 1,
                    arrowwidth: 2,
                    arrowcolor: '#ba684e',
                    ax: 60,
                    ay: 60,
                    font: { size: 12, color: '#5d2137' },
                    bgcolor: '#fee9e2',
                    bordercolor: '#ba684e',
                    borderwidth: 2,
                    borderpad: 4,
                    opacity: 0.9
                }
            ];

            // Add highlight annotation
            annotations.push({
                x: Math.log10(subject.students),
                y: subject.rewardScore,
                text: `<b>${subject.subject}</b><br>Reward: ${subject.rewardScore.toFixed(1)}`,
                showarrow: true,
                arrowhead: 2,
                arrowsize: 1,
                arrowwidth: 2,
                arrowcolor: '#5d2137',
                ax: isMobile ? 0 : 60,
                ay: isMobile ? -50 : -40,
                font: { size: isMobile ? 11 : 13, color: '#fff' },
                bgcolor: '#5d2137',
                bordercolor: '#5d2137',
                borderwidth: 2,
                borderpad: 6,
                opacity: 1
            });

            Plotly.relayout('chart', { annotations: annotations });

            // Find which trace (0=Literature, 1=Lang&Lit) and point index within that trace
            const isLit = subject.courseType === 'Literature';
            const traceIdx = isLit ? 0 : 1;
            const traceData = isLit ? litData : lalData;
            const otherTraceData = isLit ? lalData : litData;
            const otherTraceIdx = isLit ? 1 : 0;
            const pointIdx = traceData.subjects.findIndex(s => s.subject === subject.subject);

            if (pointIdx === -1) return;

            const baseSize = isMobile ? 8 : 10;

            // Highlight selected point in its trace, dim the rest
            const sizes = traceData.subjects.map((s, i) =>
                i === pointIdx ? (isMobile ? 16 : baseSize * 2) : baseSize
            );
            const opacities = traceData.subjects.map((s, i) =>
                i === pointIdx ? 1 : 0.25
            );
            const lineWidths = traceData.subjects.map((s, i) =>
                i === pointIdx ? 3 : 1
            );

            Plotly.restyle('chart', {
                'marker.size': [sizes],
                'marker.opacity': [opacities],
                'marker.line.width': [lineWidths]
            }, [traceIdx]);

            // Dim all points in the other trace
            const otherSizes = otherTraceData.subjects.map(() => baseSize);
            const otherOpacities = otherTraceData.subjects.map(() => 0.25);
            const otherLineWidths = otherTraceData.subjects.map(() => 1);

            Plotly.restyle('chart', {
                'marker.size': [otherSizes],
                'marker.opacity': [otherOpacities],
                'marker.line.width': [otherLineWidths]
            }, [otherTraceIdx]);
        }
        
        function resetChartHighlight() {
            // Restore original annotations
            const annotations = isMobile ? [] : [
                {
                    x: Math.log10(50),
                    y: 45,
                    xref: 'x',
                    yref: 'y',
                    text: 'Small cohorts:<br>Higher rewards',
                    showarrow: true,
                    arrowhead: 2,
                    arrowsize: 1,
                    arrowwidth: 2,
                    arrowcolor: '#ba684e',
                    ax: -60,
                    ay: -60,
                    font: { size: 12, color: '#5d2137' },
                    bgcolor: '#fee9e2',
                    bordercolor: '#ba684e',
                    borderwidth: 2,
                    borderpad: 4,
                    opacity: 0.9
                },
                {
                    x: Math.log10(30000),
                    y: 12,
                    xref: 'x',
                    yref: 'y',
                    text: 'Large cohorts:<br>Lower rewards',
                    showarrow: true,
                    arrowhead: 2,
                    arrowsize: 1,
                    arrowwidth: 2,
                    arrowcolor: '#ba684e',
                    ax: 60,
                    ay: 60,
                    font: { size: 12, color: '#5d2137' },
                    bgcolor: '#fee9e2',
                    bordercolor: '#ba684e',
                    borderwidth: 2,
                    borderpad: 4,
                    opacity: 0.9
                }
            ];

            Plotly.relayout('chart', { annotations: annotations });

            // Restore original marker styles for both traces
            const baseSize = isMobile ? 8 : 10;
            Plotly.restyle('chart', {
                'marker.size': [baseSize],
                'marker.opacity': [0.7],
                'marker.line.width': [1]
            }, [0, 1]);
        }
        
        function showSelectedInfo(subject) {
            const infoCard = document.getElementById('selected-info');
            const badge = document.getElementById('info-badge');
            const title = document.getElementById('info-title');
            const reward = document.getElementById('info-reward');
            const students = document.getElementById('info-students');
            const mean = document.getElementById('info-mean');
            const grade7 = document.getElementById('info-grade7');
            const grade67 = document.getElementById('info-grade67');
            
            badge.style.backgroundColor = typeColors[subject.courseType];
            badge.textContent = subject.courseType;
            title.textContent = subject.subject;
            reward.textContent = subject.rewardScore.toFixed(2);
            students.textContent = subject.students.toLocaleString();
            mean.textContent = subject.meanGrade.toFixed(1);
            grade7.textContent = subject.grade7.toFixed(1) + '%';
            grade67.textContent = subject.grade67.toFixed(1) + '%';
            
            infoCard.classList.add('active');
        }
    </script>
</body>
</html>
