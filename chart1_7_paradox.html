<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The 7 Paradox | Fenwick Tutoring</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: white;
            color: #000;
            line-height: 1.6;
            /* Prevent any scrolling - content must fit */
            overflow: hidden;
            height: 100%;
            width: 100%;
        }
        
        .container {
            width: 100%;
            height: 100%;
            margin: 0;
            background-color: white;
            padding: 15px 4%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        h1 {
            color: #5d2137;
            font-size: clamp(18px, 4vw, 32px);
            margin-bottom: 4px;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .subtitle {
            color: #ba684e;
            font-size: clamp(12px, 2vw, 18px);
            margin-bottom: 10px;
            flex-shrink: 0;
        }
        
        #chart {
            width: 100%;
            flex: 1;
            min-height: 0; /* Important for flexbox */
            overflow: hidden;
        }
        
        /* Search Container */
        .search-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 8px auto 10px auto;
            flex-shrink: 0;
        }
        
        .search-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            background: #fee9e2;
            border: 2px solid #ba684e;
            border-radius: 8px;
            overflow: hidden;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        .search-wrapper:focus-within {
            border-color: #5d2137;
            box-shadow: 0 0 0 3px rgba(93, 33, 55, 0.15);
        }
        
        .search-icon {
            padding: 0 10px;
            color: #ba684e;
            display: flex;
            align-items: center;
        }
        
        .search-icon svg {
            width: 16px;
            height: 16px;
        }
        
        #subject-search {
            flex: 1;
            padding: 10px 10px 10px 0;
            border: none;
            background: transparent;
            font-size: 14px;
            color: #5d2137;
            outline: none;
            font-family: inherit;
        }
        
        #subject-search::placeholder {
            color: #ba684e;
            opacity: 0.7;
        }
        
        .clear-btn {
            padding: 6px 10px;
            background: none;
            border: none;
            color: #ba684e;
            cursor: pointer;
            font-size: 16px;
            display: none;
            transition: color 0.2s ease;
        }
        
        .clear-btn:hover {
            color: #5d2137;
        }
        
        .clear-btn.visible {
            display: block;
        }
        
        /* Dropdown */
        .dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #ba684e;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 180px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(93, 33, 55, 0.15);
        }
        
        .dropdown.active {
            display: block;
        }
        
        .dropdown-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #fee9e2;
            transition: background-color 0.15s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item:hover,
        .dropdown-item.highlighted {
            background-color: #fee9e2;
        }
        
        .dropdown-item .subject-name {
            flex: 1;
            color: #5d2137;
            font-weight: 500;
            font-size: 13px;
        }
        
        .dropdown-item .subject-level {
            color: #ba684e;
            font-size: 12px;
        }
        
        .dropdown-item .group-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .no-results {
            padding: 12px;
            text-align: center;
            color: #ba684e;
            font-style: italic;
            font-size: 13px;
        }
        
        /* Selected subject info card */
        .selected-info {
            display: none;
            background: linear-gradient(135deg, #fee9e2 0%, #fff 100%);
            border: 2px solid #ba684e;
            border-radius: 8px;
            padding: 12px 14px;
            margin: 8px auto;
            max-width: 400px;
            animation: slideIn 0.3s ease;
            flex-shrink: 0;
        }
        
        .selected-info.active {
            display: block;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .selected-info .info-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .selected-info .info-header .group-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .selected-info .subject-title {
            color: #5d2137;
            font-weight: 700;
            font-size: 15px;
        }
        
        .selected-info .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 4px 12px;
        }
        
        .selected-info .info-item {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
        }
        
        .selected-info .info-label {
            color: #ba684e;
        }
        
        .selected-info .info-value {
            color: #5d2137;
            font-weight: 600;
        }
        
        .footer {
            text-align: center;
            color: #ba684e;
            font-size: 11px;
            padding-top: 8px;
            border-top: 2px solid #fee9e2;
            flex-shrink: 0;
        }
        
        /* Mobile Styles */
        @media (max-width: 768px) {
            .container {
                padding: 10px 3%;
            }
            
            h1 {
                font-size: 16px;
                margin-bottom: 2px;
            }
            
            .subtitle {
                font-size: 11px;
                margin-bottom: 6px;
            }
            
            .search-container {
                max-width: 100%;
                margin: 6px auto 8px auto;
            }
            
            #subject-search {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 10px 10px 10px 0;
            }
            
            .dropdown {
                max-height: 150px;
            }
            
            .dropdown-item {
                padding: 10px 12px;
            }
            
            .selected-info {
                max-width: 100%;
                padding: 10px 12px;
                margin: 6px auto;
            }
            
            .selected-info .info-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 3px 10px;
            }
            
            .selected-info .info-item {
                font-size: 12px;
            }
            
            .selected-info .subject-title {
                font-size: 14px;
            }
            
            .footer {
                font-size: 10px;
                padding-top: 6px;
            }
        }
        
        /* Desktop larger screens */
        @media (min-width: 1200px) {
            .container {
                padding: 20px 5%;
            }
            
            h1 {
                font-size: 28px;
            }
            
            .subtitle {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>The 7 Paradox: Higher Spread = More 7s</h1>
        <p class="subtitle">Subjects with more spread out grades give MORE opportunity for 7s</p>
        
        <div id="chart"></div>
        
        <!-- Search Component -->
        <div class="search-container">
            <div class="search-wrapper">
                <div class="search-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                </div>
                <input 
                    type="text" 
                    id="subject-search" 
                    placeholder="Search for a subject..."
                    autocomplete="off"
                    aria-label="Search for a subject"
                >
                <button class="clear-btn" id="clear-search" aria-label="Clear search">Ã—</button>
            </div>
            <div class="dropdown" id="dropdown"></div>
        </div>
        
        <!-- Selected Subject Info Card -->
        <div class="selected-info" id="selected-info">
            <div class="info-header">
                <div class="group-dot" id="info-dot"></div>
                <span class="subject-title" id="info-title"></span>
            </div>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Grade 7:</span>
                    <span class="info-value" id="info-grade7"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Std Dev:</span>
                    <span class="info-value" id="info-stddev"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Mean:</span>
                    <span class="info-value" id="info-mean"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">Students:</span>
                    <span class="info-value" id="info-students"></span>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p><strong>Fenwick Tutoring</strong> | Data: IB May 2025 Statistical Bulletin</p>
        </div>
    </div>

    <script>
        // Detect mobile vs desktop
        const isMobile = window.innerWidth < 768;
        
        // Global variables for search functionality
        let allSubjects = [];
        let currentTraces = [];
        let currentLayout = {};
        let highlightedIndex = -1;
        
        // Color map for subject groups - UPDATED: Arts now a distinct deep red/crimson
        const colorMap = {
            'Language Acquisition': '#2196F3',      // Blue
            'Individuals and Societies': '#4CAF50', // Green
            'Language and Literature': '#9C27B0',   // Purple
            'Sciences': '#F44336',                  // Red
            'Mathematics': '#FF9800',               // Orange
            'The Arts': '#C2185B',                  // Deep Pink/Crimson - more distinct from Sciences
            'Interdisciplinary': '#607D8B'          // Blue Grey
        };
        
        // Load and process the data
        fetch('./ib_subject_analysis_clean.csv')
            .then(response => response.text())
            .then(csvData => {
                const rows = csvData.trim().split('\n');
                const headers = rows[0].split(',');
                
                // Parse CSV data
                const data = rows.slice(1).map(row => {
                    const values = row.split(',');
                    return {
                        subject: values[0],
                        level: values[1],
                        group: values[2],
                        students: parseInt(values[3]),
                        meanGrade: parseFloat(values[4]),
                        stdDev: parseFloat(values[5]),
                        pctGrade7: parseFloat(values[12])
                    };
                });
                
                // Store all subjects for search
                allSubjects = data.map(d => ({
                    ...d,
                    displayName: `${d.subject} ${d.level}`,
                    searchKey: `${d.subject} ${d.level}`.toLowerCase()
                }));
                
                // Group data by subject group
                const groups = [...new Set(data.map(d => d.group))];
                
                const traces = groups.map(group => {
                    const groupData = data.filter(d => d.group === group);
                    
                    return {
                        x: groupData.map(d => d.stdDev),
                        y: groupData.map(d => d.pctGrade7),
                        mode: 'markers',
                        type: 'scatter',
                        name: isMobile ? group.split(' ')[0] : group, // Shortened names on mobile
                        marker: {
                            size: isMobile ? 7 : groupData.map(d => Math.sqrt(d.students) / 15),
                            color: colorMap[group],
                            opacity: 0.7,
                            line: {
                                color: '#5d2137',
                                width: 1
                            }
                        },
                        text: groupData.map(d => 
                            isMobile 
                            ? `<b>${d.subject} ${d.level}</b><br>Grade 7: ${d.pctGrade7.toFixed(1)}%<br>Std Dev: ${d.stdDev.toFixed(2)}`
                            : `<b>${d.subject} ${d.level}</b><br>` +
                              `Grade 7: ${d.pctGrade7.toFixed(1)}%<br>` +
                              `Std Dev: ${d.stdDev.toFixed(2)}<br>` +
                              `Mean Grade: ${d.meanGrade.toFixed(1)}<br>` +
                              `Students: ${d.students.toLocaleString()}`
                        ),
                        hovertemplate: '%{text}<extra></extra>',
                        hoverlabel: {
                            font: {
                                size: isMobile ? 10 : 13
                            }
                        },
                        customdata: groupData.map(d => `${d.subject} ${d.level}`)
                    };
                });
                
                // Add trend line
                const x = data.map(d => d.stdDev);
                const y = data.map(d => d.pctGrade7);
                
                const n = x.length;
                const sumX = x.reduce((a, b) => a + b, 0);
                const sumY = y.reduce((a, b) => a + b, 0);
                const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
                const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
                
                const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
                const intercept = (sumY - slope * sumX) / n;
                
                const minX = Math.min(...x);
                const maxX = Math.max(...x);
                const trendY = [minX, maxX].map(xi => slope * xi + intercept);
                
                const meanX = sumX / n;
                const meanY = sumY / n;
                const ssX = x.reduce((sum, xi) => sum + Math.pow(xi - meanX, 2), 0);
                const ssY = y.reduce((sum, yi) => sum + Math.pow(yi - meanY, 2), 0);
                const ssXY = x.reduce((sum, xi, i) => sum + (xi - meanX) * (y[i] - meanY), 0);
                const r = ssXY / Math.sqrt(ssX * ssY);
                
                traces.push({
                    x: [minX, maxX],
                    y: trendY,
                    mode: 'lines',
                    name: isMobile ? `r=${r.toFixed(2)}` : `Trend (r = ${r.toFixed(3)})`,
                    line: {
                        color: '#5d2137',
                        width: 2,
                        dash: 'dash'
                    },
                    hovertemplate: 'Positive correlation<br>r = ' + r.toFixed(3) + '<extra></extra>'
                });
                
                currentTraces = traces;
                
                const layout = {
                    xaxis: {
                        title: {
                            text: isMobile ? 'Grade Spread (Std Dev)' : 'Grade Spread (Standard Deviation)',
                            font: {
                                size: isMobile ? 10 : 14,
                                color: '#5d2137',
                                family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto'
                            }
                        },
                        gridcolor: '#fee9e2',
                        range: [0.8, 1.6],
                        zeroline: false,
                        fixedrange: true,
                        tickfont: { size: isMobile ? 9 : 12 }
                    },
                    yaxis: {
                        title: {
                            text: isMobile ? '% Grade 7' : '% Students Getting Grade 7',
                            font: {
                                size: isMobile ? 10 : 14,
                                color: '#5d2137',
                                family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto'
                            }
                        },
                        gridcolor: '#fee9e2',
                        range: [-1, 30],
                        zeroline: true,
                        zerolinecolor: '#5d2137',
                        zerolinewidth: 1,
                        fixedrange: true,
                        tickfont: { size: isMobile ? 9 : 12 }
                    },
                    hovermode: 'closest',
                    dragmode: false,
                    showlegend: true,
                    legend: isMobile ? {
                        x: 0,
                        y: 1,
                        xanchor: 'left',
                        yanchor: 'top',
                        bgcolor: 'rgba(255, 255, 255, 0.85)',
                        bordercolor: '#5d2137',
                        borderwidth: 1,
                        font: { size: 8 },
                        orientation: 'h',
                        tracegroupgap: 0,
                        itemwidth: 25
                    } : {
                        x: 0.02,
                        y: 0.98,
                        bgcolor: 'rgba(255, 255, 255, 0.8)',
                        bordercolor: '#5d2137',
                        borderwidth: 1,
                        font: { size: 11 }
                    },
                    plot_bgcolor: 'white',
                    paper_bgcolor: 'white',
                    font: {
                        family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto',
                        color: '#000'
                    },
                    margin: isMobile 
                        ? { l: 35, r: 8, t: 25, b: 40 }
                        : { l: 70, r: 30, t: 30, b: 60 },
                    annotations: isMobile ? [] : [
                        {
                            x: 1.4,
                            y: 21,
                            text: 'Subjects with more spread<br>give MORE opportunity for 7s!',
                            showarrow: true,
                            arrowhead: 2,
                            arrowsize: 1,
                            arrowwidth: 2,
                            arrowcolor: '#ba684e',
                            ax: -80,
                            ay: -50,
                            font: {
                                size: 12,
                                color: '#5d2137'
                            },
                            bgcolor: '#fee9e2',
                            bordercolor: '#ba684e',
                            borderwidth: 2,
                            borderpad: 4,
                            opacity: 0.9
                        }
                    ],
                    autosize: true
                };
                
                currentLayout = layout;
                
                const config = {
                    responsive: true,
                    displayModeBar: false,
                    displaylogo: false,
                    scrollZoom: false
                };
                
                Plotly.newPlot('chart', traces, layout, config);
                
                // Handle resize
                window.addEventListener('resize', function() {
                    Plotly.Plots.resize('chart');
                });
                
                // Initialize search functionality
                initializeSearch();
            })
            .catch(error => {
                console.error('Error loading data:', error);
                document.getElementById('chart').innerHTML = 
                    '<div style="text-align: center; padding: 50px; color: #ba684e;">' +
                    '<p>Error loading data. Please ensure ib_subject_analysis_clean.csv is in the same directory.</p>' +
                    '</div>';
            });
        
        // Search functionality
        function initializeSearch() {
            const searchInput = document.getElementById('subject-search');
            const dropdown = document.getElementById('dropdown');
            const clearBtn = document.getElementById('clear-search');
            
            // Search input handler
            searchInput.addEventListener('input', function(e) {
                const query = e.target.value.toLowerCase().trim();
                highlightedIndex = -1;
                
                // Show/hide clear button
                clearBtn.classList.toggle('visible', query.length > 0);
                
                if (query.length === 0) {
                    dropdown.classList.remove('active');
                    resetChartHighlight();
                    return;
                }
                
                // Filter subjects
                const matches = allSubjects.filter(s => 
                    s.searchKey.includes(query) ||
                    s.subject.toLowerCase().includes(query) ||
                    s.level.toLowerCase().includes(query)
                ).slice(0, 8); // Limit to 8 results for mobile
                
                renderDropdown(matches);
            });
            
            // Keyboard navigation
            searchInput.addEventListener('keydown', function(e) {
                const items = dropdown.querySelectorAll('.dropdown-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    highlightedIndex = Math.min(highlightedIndex + 1, items.length - 1);
                    updateHighlight(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    highlightedIndex = Math.max(highlightedIndex - 1, 0);
                    updateHighlight(items);
                } else if (e.key === 'Enter' && highlightedIndex >= 0) {
                    e.preventDefault();
                    const selectedName = items[highlightedIndex].dataset.name;
                    selectSubject(selectedName);
                } else if (e.key === 'Escape') {
                    dropdown.classList.remove('active');
                    searchInput.blur();
                }
            });
            
            // Focus handling
            searchInput.addEventListener('focus', function() {
                if (searchInput.value.trim().length > 0) {
                    const query = searchInput.value.toLowerCase().trim();
                    const matches = allSubjects.filter(s => s.searchKey.includes(query)).slice(0, 8);
                    renderDropdown(matches);
                }
            });
            
            // Clear button
            clearBtn.addEventListener('click', function() {
                searchInput.value = '';
                clearBtn.classList.remove('visible');
                dropdown.classList.remove('active');
                resetChartHighlight();
                document.getElementById('selected-info').classList.remove('active');
                searchInput.focus();
            });
            
            // Click outside to close
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container')) {
                    dropdown.classList.remove('active');
                }
            });
        }
        
        function renderDropdown(matches) {
            const dropdown = document.getElementById('dropdown');
            
            if (matches.length === 0) {
                dropdown.innerHTML = '<div class="no-results">No subjects found</div>';
                dropdown.classList.add('active');
                return;
            }
            
            dropdown.innerHTML = matches.map((s, index) => `
                <div class="dropdown-item" data-name="${s.displayName}" data-index="${index}">
                    <div class="group-dot" style="background-color: ${colorMap[s.group]}"></div>
                    <span class="subject-name">${s.subject}</span>
                    <span class="subject-level">${s.level}</span>
                </div>
            `).join('');
            
            // Add click handlers
            dropdown.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', function() {
                    selectSubject(this.dataset.name);
                });
            });
            
            dropdown.classList.add('active');
        }
        
        function updateHighlight(items) {
            items.forEach((item, index) => {
                item.classList.toggle('highlighted', index === highlightedIndex);
            });
            
            // Scroll into view if needed
            if (highlightedIndex >= 0 && items[highlightedIndex]) {
                items[highlightedIndex].scrollIntoView({ block: 'nearest' });
            }
        }
        
        function selectSubject(displayName) {
            const searchInput = document.getElementById('subject-search');
            const dropdown = document.getElementById('dropdown');
            const clearBtn = document.getElementById('clear-search');
            
            // Update input
            searchInput.value = displayName;
            clearBtn.classList.add('visible');
            dropdown.classList.remove('active');
            
            // Find subject data
            const subject = allSubjects.find(s => s.displayName === displayName);
            if (subject) {
                highlightSubjectOnChart(subject);
                showSelectedInfo(subject);
            }
        }
        
        function highlightSubjectOnChart(subject) {
            // Find which trace and point index this subject belongs to
            const groups = [...new Set(allSubjects.map(s => s.group))];
            const traceIndex = groups.indexOf(subject.group);
            
            if (traceIndex === -1) return;
            
            // Create annotation for the selected point
            const annotations = isMobile ? [] : [
                // Original annotation
                {
                    x: 1.4,
                    y: 21,
                    text: 'Subjects with more spread<br>give MORE opportunity for 7s!',
                    showarrow: true,
                    arrowhead: 2,
                    arrowsize: 1,
                    arrowwidth: 2,
                    arrowcolor: '#ba684e',
                    ax: -80,
                    ay: -50,
                    font: { size: 12, color: '#5d2137' },
                    bgcolor: '#fee9e2',
                    bordercolor: '#ba684e',
                    borderwidth: 2,
                    borderpad: 4,
                    opacity: 0.9
                }
            ];
            
            // Add highlight annotation
            annotations.push({
                x: subject.stdDev,
                y: subject.pctGrade7,
                text: isMobile 
                    ? `<b>${subject.subject}</b><br>${subject.pctGrade7.toFixed(1)}%`
                    : `<b>${subject.subject} ${subject.level}</b><br>Grade 7: ${subject.pctGrade7.toFixed(1)}%`,
                showarrow: true,
                arrowhead: 2,
                arrowsize: 1,
                arrowwidth: 2,
                arrowcolor: '#5d2137',
                ax: isMobile ? 0 : 60,
                ay: isMobile ? -40 : -40,
                font: { size: isMobile ? 10 : 13, color: '#fff' },
                bgcolor: '#5d2137',
                bordercolor: '#5d2137',
                borderwidth: 2,
                borderpad: isMobile ? 4 : 6,
                opacity: 1
            });
            
            // Update layout with new annotation
            Plotly.relayout('chart', { annotations: annotations });
            
            // Dim other points and highlight the selected one
            const updates = [];
            const indices = [];
            
            currentTraces.forEach((trace, idx) => {
                if (trace.mode === 'lines') return; // Skip trend line
                
                const groupName = groups[idx];
                if (!groupName) return;
                
                const isTargetGroup = groupName === subject.group;
                
                if (isTargetGroup) {
                    // Create new marker sizes and opacities
                    const sizes = [];
                    const opacities = [];
                    const lineWidths = [];
                    
                    const groupSubjects = allSubjects.filter(s => s.group === groupName);
                    groupSubjects.forEach((s, i) => {
                        const isTarget = s.displayName === subject.displayName;
                        const baseSize = isMobile ? 7 : Math.sqrt(s.students) / 15;
                        
                        sizes.push(isTarget ? (isMobile ? 14 : baseSize * 1.8) : baseSize);
                        opacities.push(isTarget ? 1 : 0.25);
                        lineWidths.push(isTarget ? 3 : 1);
                    });
                    
                    updates.push({
                        'marker.size': [sizes],
                        'marker.opacity': [opacities],
                        'marker.line.width': [lineWidths]
                    });
                } else {
                    // Dim other groups
                    updates.push({
                        'marker.opacity': [0.15]
                    });
                }
                indices.push(idx);
            });
            
            // Apply updates
            updates.forEach((update, i) => {
                Plotly.restyle('chart', update, [indices[i]]);
            });
        }
        
        function resetChartHighlight() {
            // Restore original annotations
            const annotations = isMobile ? [] : [
                {
                    x: 1.4,
                    y: 21,
                    text: 'Subjects with more spread<br>give MORE opportunity for 7s!',
                    showarrow: true,
                    arrowhead: 2,
                    arrowsize: 1,
                    arrowwidth: 2,
                    arrowcolor: '#ba684e',
                    ax: -80,
                    ay: -50,
                    font: { size: 12, color: '#5d2137' },
                    bgcolor: '#fee9e2',
                    bordercolor: '#ba684e',
                    borderwidth: 2,
                    borderpad: 4,
                    opacity: 0.9
                }
            ];
            
            Plotly.relayout('chart', { annotations: annotations });
            
            // Restore original marker styles
            const groups = [...new Set(allSubjects.map(s => s.group))];
            
            groups.forEach((group, idx) => {
                const groupSubjects = allSubjects.filter(s => s.group === group);
                const sizes = isMobile ? 7 : groupSubjects.map(s => Math.sqrt(s.students) / 15);
                
                Plotly.restyle('chart', {
                    'marker.size': [sizes],
                    'marker.opacity': [0.7],
                    'marker.line.width': [1]
                }, [idx]);
            });
        }
        
        function showSelectedInfo(subject) {
            const infoCard = document.getElementById('selected-info');
            const dot = document.getElementById('info-dot');
            const title = document.getElementById('info-title');
            const grade7 = document.getElementById('info-grade7');
            const stddev = document.getElementById('info-stddev');
            const mean = document.getElementById('info-mean');
            const students = document.getElementById('info-students');
            
            dot.style.backgroundColor = colorMap[subject.group];
            title.textContent = subject.displayName;
            grade7.textContent = subject.pctGrade7.toFixed(1) + '%';
            stddev.textContent = subject.stdDev.toFixed(2);
            mean.textContent = subject.meanGrade.toFixed(1);
            students.textContent = subject.students.toLocaleString();
            
            infoCard.classList.add('active');
        }
    </script>
</body>
</html>
